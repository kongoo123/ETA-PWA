<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ship ETA Calculator | 船舶ETA计算器 (Mobile)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2E86AB">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Microsoft YaHei UI", sans-serif; margin: 0; background:#f6f8fa; color:#223; }
  .container { padding: 10px; }
  .row { display:flex; gap:10px; }
  .col { flex:1; }
  .card { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06); padding:12px; margin-bottom:10px; }
  h2 { font-size:15px; margin:2px 0 8px; color:#2E86AB; }
  label { font-size:13px; color:#556; display:block; }
  input[type="text"], input[type="number"] { width:100%; padding:12px; font-size:16px; border:1px solid #dce1e7; border-radius:10px; background:#fbfcfd; box-sizing:border-box; }
  .btnbar { display:flex; gap:10px; }
  button { flex:1; padding:12px 14px; font-size:16px; border:none; border-radius:10px; background:#2E86AB; color:#fff; box-shadow:0 2px 6px rgba(46,134,171,.25); }
  button.secondary { background:#6c7a89; }
  .output { white-space:pre-wrap; font-size:15px; line-height:1.3; background:#fbfcfd; border:1px solid #e8ecf1; border-radius:12px; padding:12px; }
  .eta { color:#2E86AB; font-weight:700; }
  .note { color:#667; font-size:12px; text-align:center; }

  /* Alignment helpers */
  .field { display:flex; flex-direction:column; gap:6px; }
  .field label { margin-bottom:0; }
  .help { font-size:11px; color:#7a8796; min-height:14px; }
  .hint { font-size:11px; color:#7a8796; margin-left:6px; font-weight:400; }

  .tz-compact { display:flex; gap:8px; align-items:flex-start; }
  .tz-compact .small { max-width:95px; }
  .dir-field { display:flex; flex-direction:column; gap:6px; }
  .dir-options { display:flex; gap:10px; align-items:center; border:1px solid #dce1e7; background:#fbfcfd; border-radius:10px; padding:8px 10px; }
  .dir-options label { margin:0; font-size:13px; color:#223; }
  .dir-options input { margin-right:4px; }
</style>
</head>
<body>
<div class="container">
  <!-- compact UI -->

  <div class="card">
    <h2>Voyage | 航程（单航段）</h2>
    <div class="row">
      <div class="col field">
        <label>Distance NM</label>
        <input id="leg_nm" type="number" inputmode="decimal" placeholder="260" />
      </div>
      <div class="col field">
        <label>Speed KTS</label>
        <input id="leg_kts" type="number" inputmode="decimal" placeholder="12" />
      </div>
    </div>
    <div class="tz-compact" style="margin-top:6px;">
      <div class="field">
        <label>Departure TZ</label>
        <input id="dep_tz" class="small" type="number" step="1" placeholder="8" />
        <div class="help">Hint: E8 = 8, W3 = -3</div>
      </div>
      <div class="field">
        <label>Arrival TZ</label>
        <input id="arr_tz" class="small" type="number" step="1" placeholder="9" />
        <div class="help">Hint: E8 = 8, W3 = -3</div>
      </div>
      <div class="field dir-field">
        <label>Course</label>
        <div class="dir-options">
          <label><input type="radio" name="dir" value="东行" checked> East</label>
          <label><input type="radio" name="dir" value="西行"> West</label>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Times | 时间</h2>
    <div class="row">
      <div class="col field">
        <label>Departure<span class="hint">(yyyymmdd)</span></label>
        <input id="dep_date" type="text" placeholder="20241201" />
      </div>
      <div class="col field">
        <label>Time (hhmm)</label>
        <input id="dep_time" type="text" placeholder="1200" />
      </div>
    </div>
    <div class="row" style="margin-top:6px;">
      <div class="col field">
        <label>Target ETA<span class="hint">(yyyymmdd)</span></label>
        <input id="tgt_date" type="text" placeholder="20241202" />
      </div>
      <div class="col field">
        <label>Time (hhmm)</label>
        <input id="tgt_time" type="text" placeholder="0800" />
      </div>
    </div>
    <div class="btnbar" style="margin-top:10px;">
      <button id="btn_eta" type="button">Calculate ETA</button>
      <button id="btn_speed" type="button" class="secondary">Required Speed</button>
    </div>
  </div>

  <div class="card">
    <h2>Summary | 摘要</h2>
    <div id="output" class="output">请输入数据后点击按钮计算…</div>
    <div class="note" style="margin-top:6px;">By XIA</div>
  </div>
</div>

<script>
(function(){
  // Register Service Worker (PWA)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() { navigator.serviceWorker.register('sw.js'); });
  }

  function getDirection(){
    const r = document.querySelector('input[name="dir"]:checked');
    return r ? r.value : '东行';
  }

  (function setDefaultDepartureNow(){
    const dEl = document.getElementById('dep_date');
    const tEl = document.getElementById('dep_time');
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = ('0'+(now.getMonth()+1)).slice(-2);
    const dd = ('0'+now.getDate()).slice(-2);
    const hh = ('0'+now.getHours()).slice(-2);
    const mi = ('0'+now.getMinutes()).slice(-2);
    if(!dEl.value) dEl.value = `${yyyy}${mm}${dd}`;
    if(!tEl.value) tEl.value = `${hh}${mi}`;
  })();

  function parseYmdHm(d,t){
    if(!/^\d{8}$/.test(d||'') || !/^\d{4}$/.test(t||'')) throw new Error('日期或时间格式错误');
    const y = +d.slice(0,4), m = +d.slice(4,6)-1, day = +d.slice(6,8);
    const hh = +t.slice(0,2), mm = +t.slice(2,4);
    return new Date(y, m, day, hh, mm, 0);
  }

  function calculateTimezoneDifference(depTZ, arrTZ, dir){
    const direct = arrTZ - depTZ;
    if(dir==='东行'){
      if(direct < -12) return 24 - (depTZ - arrTZ);
      else if(direct < 0) return 24 + direct;
      else return direct;
    }else{
      if(direct > 12) return -24 + direct;
      else if(direct > 0) return direct - 24;
      else return direct;
    }
  }
  function detectIDL(depTZ, arrTZ, dir){
    const direct = arrTZ - depTZ;
    if(dir==='东行') return (direct < -12) || (direct < 0);
    else return (direct > 12) || (direct > 0);
  }

  function hoursBetween(a,b){ return (b - a) / 3600000; }
  function addHours(d,h){ return new Date(d.getTime() + h*3600000); }
  function addDays(d,n){ return new Date(d.getTime() + n*86400000); }

  function val(id){ const v = document.getElementById(id).value.trim(); return v; }
  function num(id){ const v = val(id); return v===''? null : Number(v); }

  function legHours(){
    const d = num('leg_nm');
    const s = num('leg_kts');
    if(d!=null && s!=null && s>0) return d/s; else return 0;
  }

  function totalNM(){ const v = num('leg_nm'); return v? v:0; }

  function formatTZ(v){ return (v>=0? '+'+v : ''+v) + ' TZ'; }
  function fmtDate(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const da=('0'+d.getDate()).slice(-2); const h=('0'+d.getHours()).slice(-2); const mi=('0'+d.getMinutes()).slice(-2); return `${y}-${m}-${da} ${h}:${mi}`; }

  function computeETA(){
    try{
      const depDT = parseYmdHm(val('dep_date'), val('dep_time'));
      const depTZ = Number(val('dep_tz')||0), arrTZ = Number(val('arr_tz')||0);
      const dir = getDirection();
      const zoneDiff = calculateTimezoneDifference(depTZ, arrTZ, dir);
      let eta = addHours(depDT, legHours() + zoneDiff);
      const cross = detectIDL(depTZ, arrTZ, dir);
      if(cross){ eta = addDays(eta, dir==='东行'? -1 : +1); }
      const idlText = cross ? (dir==='东行' ? ' | IDL: retarded one day' : ' | IDL: advanced one day') : ' | IDL: No';
      document.getElementById('output').innerHTML =
        `Departure: ${fmtDate(depDT)} (${formatTZ(depTZ)})\n`+
        `Travel: ${legHours().toFixed(1)}h | TZ Adj: ${zoneDiff>=0?'+':''}${zoneDiff.toFixed(1)}h${idlText}\n\n`+
        `ETA: <span class="eta">${fmtDate(eta)} (${formatTZ(arrTZ)})</span>`;
    }catch(e){
      document.getElementById('output').textContent = `Error: ${e.message || e}`;
    }
  }

  function computeRequiredSpeed(){
    try{
      const depDT = parseYmdHm(val('dep_date'), val('dep_time'));
      const tgtDT = parseYmdHm(val('tgt_date'), val('tgt_time'));
      const depTZ = Number(val('dep_tz')||0), arrTZ = Number(val('arr_tz')||0);
      const dir = getDirection();
      const zoneDiff = calculateTimezoneDifference(depTZ, arrTZ, dir);
      const cross = detectIDL(depTZ, arrTZ, dir);
      const idlText = cross ? (dir==='东行' ? ' | IDL: retarded one day' : ' | IDL: advanced one day') : ' | IDL: No';
      const idlDays = cross? (dir==='东行'? -1: +1) : 0;
      const available = hoursBetween(depDT, tgtDT) - zoneDiff - (idlDays*24);
      if(available <= 0) throw new Error('可用航行时间不合理（小于或等于0小时）');
      const nm = totalNM();
      if(nm <= 0) throw new Error('总航程需要大于0 NM');
      const reqKTS = nm / available;
      document.getElementById('output').innerHTML =
        `Distance: ${nm.toFixed(1)} NM\n`+
        `Departure: ${fmtDate(depDT)} (${formatTZ(depTZ)})\n`+
        `Target ETA: ${fmtDate(tgtDT)} (${formatTZ(arrTZ)})\n`+
        `TZ Adj: ${zoneDiff>=0?'+':''}${zoneDiff.toFixed(1)}h${idlText}\n`+
        `Available: ${available.toFixed(2)}h\n\n`+
        `Required Speed: <span class="eta">${reqKTS.toFixed(2)} KTS</span>`;
    }catch(e){
      document.getElementById('output').textContent = `Error: ${e.message || e}`;
    }
  }

  document.getElementById('btn_eta').onclick = computeETA;
  document.getElementById('btn_speed').onclick = computeRequiredSpeed;
})();
</script>
</body>
</html>
